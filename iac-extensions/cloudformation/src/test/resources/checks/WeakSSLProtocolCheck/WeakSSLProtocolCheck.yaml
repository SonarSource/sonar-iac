AWSTemplateFormatVersion: '2010-09-09'
Resources:
  WeakSecurityPolicyV1:
    Type: AWS::ApiGateway::DomainName
    Properties:
      SecurityPolicy: "TLS_1_0"  # Noncompliant {{Change this code to disable support of older TLS versions.}}
      #               ^^^^^^^^^

  NoSecurityPolicyV1:
    Type: AWS::ApiGateway::DomainName # Compliant, defaults to TLS 1.2
    Properties:
      Foo: Bar

  StrongSecurityPolicyV1:
    Type: AWS::ApiGateway::DomainName
    Properties:
      SecurityPolicy: "TLS_1_2"

  WeakSecurityPolicyV2:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainNameConfigurations:
        - SecurityPolicy: "TLS_1_0"  # Noncompliant {{Change this code to disable support of older TLS versions.}}
          #               ^^^^^^^^^

  WeakSecurityPolicyV2MultipleConfigs:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainNameConfigurations:
        - "foo"
        - Bar: "bar"
        - SecurityPolicy: "TLS_1_0"  # Noncompliant {{Change this code to disable support of older TLS versions.}}
          #               ^^^^^^^^^


  NoSecurityPolicyV2:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainNameConfigurations: # Compliant, security policy defaults to TLS 1.2
        - Foo: Bar

  DomainNameConfiguration:
    Type: AWS::ApiGatewayV2::DomainName # Compliant, security policy defaults to TLS 1.2
    Properties:
      Foo: Bar

  StrongSecurityPolicyV2:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainNameConfigurations:
        - SecurityPolicy: "TLS_1_2"

  ElasticNoOptions:
    Type: 'AWS::Elasticsearch::Domain' # Noncompliant {{Set "DomainEndpointOptions.TLSSecurityPolicy" to disable support of older TLS versions.}}

  ElasticWeakPolicy:
    Type: 'AWS::Elasticsearch::Domain'
    Properties:
      DomainEndpointOptions:
        TLSSecurityPolicy: "Policy-Min-TLS-1-0-2019-07"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  ElasticNoPolicy:
    Type: 'AWS::Elasticsearch::Domain'
    Properties:
      DomainEndpointOptions: # Noncompliant {{Set "TLSSecurityPolicy" to disable support of older TLS versions.}}
        Foo: Bar

  ElasticStrongPolicy:
    Type: 'AWS::Elasticsearch::Domain'
    Properties:
      DomainEndpointOptions:
        TLSSecurityPolicy: "Policy-Min-TLS-1-2-2019-07"

  ElasticStrongPfsPolicy:
    Type: 'AWS::Elasticsearch::Domain'
    Properties:
      DomainEndpointOptions:
        TLSSecurityPolicy: "Policy-Min-TLS-1-2-PFS-2023-10"

  OpenSearchNoOptions:
    Type: 'AWS::OpenSearchService::Domain' # Noncompliant {{Set "DomainEndpointOptions.TLSSecurityPolicy" to disable support of older TLS versions.}}

  OpenSearchWeakPolicy:
    Type: 'AWS::OpenSearchService::Domain'
    Properties:
      DomainEndpointOptions:
        TLSSecurityPolicy: "Policy-Min-TLS-1-0-2019-07"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  OpenSearchNoPolicy:
    Type: 'AWS::OpenSearchService::Domain'
    Properties:
      DomainEndpointOptions: # Noncompliant {{Set "TLSSecurityPolicy" to disable support of older TLS versions.}}
        Foo: Bar

  OpenSearchStrongPolicy:
    Type: 'AWS::OpenSearchService::Domain'
    Properties:
      DomainEndpointOptions:
        TLSSecurityPolicy: "Policy-Min-TLS-1-2-2019-07"

  OpenSearchStrongPfsPolicy:
    Type: 'AWS::OpenSearchService::Domain'
    Properties:
      DomainEndpointOptions:
        TLSSecurityPolicy: "Policy-Min-TLS-1-2-PFS-2023-10"

  NoApiGateWay:
    Type: 'Something else'
    Properties:
      SecurityPolicy: "TLS_1_0"

  UnresolvedFunctionReference:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainNameConfigurations:
        - SecurityPolicy: !GetAtt security.policy

  # ELBv2 Listener tests
  Elbv2ListenerWeakPolicy10:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: HTTPS
      SslPolicy: "ELBSecurityPolicy-TLS13-1-0-2021-06"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  Elbv2ListenerWeakPolicy11:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: HTTPS
      SslPolicy: "ELBSecurityPolicy-TLS13-1-1-2021-06"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  Elbv2ListenerWeakPolicy2016:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: TLS
      SslPolicy: "ELBSecurityPolicy-2016-08"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  Elbv2ListenerWeakPolicyExplicit:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: HTTPS
      SslPolicy: "ELBSecurityPolicy-TLS-1-1-2017-01"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  Elbv2ListenerMissingPolicy:
    Type: AWS::ElasticLoadBalancingV2::Listener # Noncompliant {{Set "SslPolicy" to disable support of older TLS versions.}}
    Properties:
      Protocol: HTTPS

  Elbv2ListenerStrongPolicy:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: HTTPS
      SslPolicy: "ELBSecurityPolicy-TLS13-1-2-2021-06"

  Elbv2ListenerStrongPolicyRes:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: HTTPS
      SslPolicy: "ELBSecurityPolicy-TLS13-1-2-Res-2021-06"

  # Compliant, HTTP protocol is covered by another check
  Elbv2ListenerHttpProtocol:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Protocol: HTTP

  Elbv2ListenerNoProtocol:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      Port: 443

  # Classic ELB tests
  ClassicElbWeakPolicy:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners:
        - Protocol: HTTPS
          LoadBalancerPort: 443
          InstancePort: 80
          PolicyNames:
            - MyWeakPolicy
      Policies:
        - PolicyName: MyWeakPolicy
          PolicyType: SSLNegotiationPolicyType
          Attributes:
            - Name: Reference-Security-Policy
              Value: "ELBSecurityPolicy-2016-08"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  ClassicElbWeakPolicy10:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners:
        - Protocol: SSL
          LoadBalancerPort: 443
          InstancePort: 80
          PolicyNames:
            - MyWeakPolicy10
      Policies:
        - PolicyName: MyWeakPolicy10
          PolicyType: SSLNegotiationPolicyType
          Attributes:
            - Name: Reference-Security-Policy
              Value: "ELBSecurityPolicy-TLS13-1-0-2021-06"  # Noncompliant {{Change this code to disable support of older TLS versions.}}

  # A strong policy is defined, but not referenced by the listener => we raise
  ClassicElbMissingPolicyReference:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners: # Noncompliant {{Set "PolicyNames" to disable support of older TLS versions.}}
        - Protocol: HTTPS
          LoadBalancerPort: 443
          InstancePort: 80
      Policies:
        - PolicyName: MyPolicy
          PolicyType: SSLNegotiationPolicyType
          Attributes:
            - Name: Reference-Security-Policy
              Value: "ELBSecurityPolicy-TLS13-1-2-2021-06"

  ClassicElbMissingPolicies:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners: # Noncompliant {{Set "Policies" to disable support of older TLS versions.}}
        - Protocol: HTTPS
          LoadBalancerPort: 443
          InstancePort: 80
          PolicyNames:
            - MyPolicy

  ClassicElbMissingPolicyValue:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners:
        - Protocol: HTTPS
          LoadBalancerPort: 443
          InstancePort: 80
          PolicyNames:
            - MyPolicy
      Policies:
        - PolicyName: MyPolicy # Noncompliant {{Set "Reference-Security-Policy" to disable support of older TLS versions.}}
          PolicyType: SSLNegotiationPolicyType
          Attributes:
            - Name: SomeOtherAttribute
              Value: "foo"

  ClassicElbStrongPolicy:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners:
        - Protocol: HTTPS
          LoadBalancerPort: 443
          InstancePort: 80
          PolicyNames:
            - MyStrongPolicy
      Policies:
        - PolicyName: MyStrongPolicy
          PolicyType: SSLNegotiationPolicyType
          Attributes:
            - Name: Reference-Security-Policy
              Value: "ELBSecurityPolicy-TLS13-1-2-2021-06"

  ClassicElbHttpProtocol:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners:
        - Protocol: HTTP
          LoadBalancerPort: 80
          InstancePort: 80

  ClassicElbNonSslPolicy:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners: # Noncompliant {{Add a policy of type "SSLNegotiationPolicyType" to disable support of older TLS versions}}
        - Protocol: HTTPS
          LoadBalancerPort: 443
          InstancePort: 80
          PolicyNames:
            - MyOtherPolicy
      Policies:
        - PolicyName: MyOtherPolicy
          PolicyType: SomeOtherPolicyType

  # Multiple policies - with one weak SSL policy
  ClassicElbMultiplePoliciesWithWeakSsl:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      Listeners:
        - Protocol: HTTPS
          LoadBalancerPort: 443
          InstancePort: 80
          PolicyNames:
            - MyAppCookiePolicy
            - MySslPolicy
      Policies:
        - PolicyName: MyAppCookiePolicy
          PolicyType: AppCookieStickinessPolicyType
          Attributes:
            - Name: CookieName
              Value: my-cookie
        - PolicyName: MySslPolicy
          PolicyType: SSLNegotiationPolicyType
          Attributes:
            - Name: Reference-Security-Policy
              Value: "ELBSecurityPolicy-2016-08"  # Noncompliant {{Change this code to disable support of older TLS versions.}}
